name: Deploy

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:
    inputs:
      target_env:
        description: "Environment to deploy (dev/prod)"
        required: false
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      run_mode:
        description: "Choose deploy or rollback"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - rollback
      rollback_ref:
        description: "Git ref/sha to rollback to (used only when run_mode=rollback)"
        required: false
        default: "main"
        type: string

env:
  PYTHON_VERSION: "3.11"
  DBT_PROFILES_DIR: ".github/dbt"

jobs:
  preflight:
    name: Pre-deployment validation
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'deploy'
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.resolve_env.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment
        id: resolve_env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "target_env=${{ github.event.inputs.target_env }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "target_env=prod" >> $GITHUB_OUTPUT
          else
            echo "target_env=dev" >> $GITHUB_OUTPUT
          fi

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Install SQL Server ODBC driver (msodbcsql18)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18 unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> $GITHUB_ENV

      - name: Install SQL Server ODBC driver (msodbcsql18)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18 unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> $GITHUB_ENV

      - name: Install SQL Server ODBC driver (msodbcsql18)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18 unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target ${{ steps.resolve_env.outputs.target_env }}

      - name: Pre-deployment validation (dbt debug + compile)
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_PROD_SERVER: ${{ secrets.DBT_PROD_SERVER || secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_PROD_USER: ${{ secrets.DBT_PROD_USER || secrets.DBT_DEV_USER || 'sa' }}
          DBT_PROD_PASSWORD: ${{ secrets.DBT_PROD_PASSWORD || secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_PROD_DATABASE: ${{ secrets.DBT_PROD_DATABASE || secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
        run: |
          dbt debug --profiles-dir ../.github/dbt --target ${{ steps.resolve_env.outputs.target_env }}
          dbt compile --profiles-dir ../.github/dbt --target ${{ steps.resolve_env.outputs.target_env }} --warn-error

  deploy:
    name: Deploy
    needs: preflight
    runs-on: ubuntu-latest
    environment: ${{ needs.preflight.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target ${{ needs.preflight.outputs.target_env }}

      - name: Run dbt models
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_PROD_SERVER: ${{ secrets.DBT_PROD_SERVER || secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_PROD_USER: ${{ secrets.DBT_PROD_USER || secrets.DBT_DEV_USER || 'sa' }}
          DBT_PROD_PASSWORD: ${{ secrets.DBT_PROD_PASSWORD || secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_PROD_DATABASE: ${{ secrets.DBT_PROD_DATABASE || secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
        run: dbt run --profiles-dir ../.github/dbt --target ${{ needs.preflight.outputs.target_env }} --fail-fast

      - name: Data quality tests
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_PROD_SERVER: ${{ secrets.DBT_PROD_SERVER || secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_PROD_USER: ${{ secrets.DBT_PROD_USER || secrets.DBT_DEV_USER || 'sa' }}
          DBT_PROD_PASSWORD: ${{ secrets.DBT_PROD_PASSWORD || secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_PROD_DATABASE: ${{ secrets.DBT_PROD_DATABASE || secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
        run: dbt test --profiles-dir ../.github/dbt --target ${{ needs.preflight.outputs.target_env }} --store-failures --fail-fast

      - name: Post-deployment health checks
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_PROD_SERVER: ${{ secrets.DBT_PROD_SERVER || secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_PROD_USER: ${{ secrets.DBT_PROD_USER || secrets.DBT_DEV_USER || 'sa' }}
          DBT_PROD_PASSWORD: ${{ secrets.DBT_PROD_PASSWORD || secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_PROD_DATABASE: ${{ secrets.DBT_PROD_DATABASE || secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
        run: |
          dbt source freshness --profiles-dir ../.github/dbt --target ${{ needs.preflight.outputs.target_env }} --output json
          dbt list --profiles-dir ../.github/dbt --target ${{ needs.preflight.outputs.target_env }} --resource-type model

      - name: Package deployment logs
        if: always()
        run: |
          tar -czf dbt-logs.tar.gz dbt/logs dbt/target || true

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-deployment-${{ needs.preflight.outputs.target_env }}
          path: |
            dbt-logs.tar.gz
            dbt/target

      - name: Deployment notification
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = "${{ job.status }}";
            const envName = "${{ needs.preflight.outputs.target_env }}";
            const sha = context.sha;
            const body = `Deployment to **${envName}** ${status === "success" ? "succeeded" : "finished with status: " + status}.`;
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body,
            });

  rollback:
    name: Rollback
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_mode == 'rollback'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rollback ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_ref }}

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target ${{ github.event.inputs.target_env }}

      - name: Rollback dbt run
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_PROD_SERVER: ${{ secrets.DBT_PROD_SERVER || secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_PROD_USER: ${{ secrets.DBT_PROD_USER || secrets.DBT_DEV_USER || 'sa' }}
          DBT_PROD_PASSWORD: ${{ secrets.DBT_PROD_PASSWORD || secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_PROD_DATABASE: ${{ secrets.DBT_PROD_DATABASE || secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
        run: |
          dbt run --profiles-dir ../.github/dbt --target ${{ github.event.inputs.target_env }} --full-refresh
          dbt test --profiles-dir ../.github/dbt --target ${{ github.event.inputs.target_env }} --store-failures --fail-fast

      - name: Rollback notification
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = "${{ job.status }}";
            const envName = "${{ github.event.inputs.target_env }}";
            const sha = context.sha;
            const body = `Rollback to ref \`${{ github.event.inputs.rollback_ref }}\` on **${envName}** ${status === "success" ? "succeeded" : "finished with status: " + status}.`;
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body,
            });
