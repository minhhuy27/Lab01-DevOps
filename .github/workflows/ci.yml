name: CI

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  DBT_PROFILES_DIR: ".github/dbt"
  DBT_TARGET: "dev"

jobs:
  pr_validation:
    name: PR validation
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR title, file sizes, and conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const pull_number = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number,
            });

            const titlePattern = /^(feat|fix|chore|docs|ci|refactor|test):\s.+/i;
            if (!titlePattern.test(pr.title)) {
              core.setFailed(
                `PR title must match "<type>: summary" (feat|fix|chore|docs|ci|refactor|test). Current: "${pr.title}"`
              );
            }

            if (pr.mergeable_state === "dirty") {
              core.setFailed("PR has merge conflicts. Please resolve before merging.");
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number,
              per_page: 100,
            });

            const isIgnoredLargeFile = (filename) => {
              const lower = filename.toLowerCase();
              return (
                lower.endsWith(".log") ||
                lower.startsWith("airflow/logs/") ||
                lower.startsWith("dbt/logs/") ||
                lower.startsWith("dbt/target/")
              );
            };

            const oversize = files.filter((file) => {
              if (isIgnoredLargeFile(file.filename)) return false;
              const changeCount = file.additions + file.deletions;
              return changeCount > 4000 || file.changes > 2000;
            });
            if (oversize.length > 0) {
              core.setFailed(
                `PR touches very large files/changes: ${oversize
                  .map((f) => `${f.filename} (${f.additions + f.deletions} changes)`)
                  .join(", ")}`
              );
            }

            const bigBinary = files.filter((file) => (file.status === "added" || file.status === "modified") && (file.patch === undefined));
            if (bigBinary.length > 0) {
              core.info(`Binary/large files detected: ${bigBinary.map((f) => f.filename).join(", ")}`);
            }

  lint_python:
    name: Lint Python (black/flake8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r airflow/requirements.txt -r dbt/requirements.txt black flake8

      - name: Run black
        run: black --check airflow dbt

      - name: Run flake8
        run: flake8 airflow dbt

  lint_sql:
    name: Lint SQL (sqlfluff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SQL Server ODBC driver (msodbcsql18)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18 unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> $GITHUB_ENV

      - name: Start local SQL Server for lint
        env:
          SA_PASSWORD: Password123!
        run: |
          docker rm -f sqlserver-lint || true
          docker run -e 'ACCEPT_EULA=Y' -e "SA_PASSWORD=${SA_PASSWORD}" -p 1433:1433 -d --name sqlserver-lint mcr.microsoft.com/mssql/server:2019-latest
          for i in {1..45}; do
            /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "${SA_PASSWORD}" -Q "SELECT 1" && break || sleep 2
          done
          /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "${SA_PASSWORD}" -Q "IF DB_ID('AdventureWorks2014') IS NULL CREATE DATABASE AdventureWorks2014"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
          DBT_DEV_SERVER: localhost
          DBT_DEV_PORT: 1433
          DBT_DEV_USER: sa
          DBT_DEV_PASSWORD: Password123!
          DBT_DEV_DATABASE: AdventureWorks2014
          DBT_DEV_SCHEMA: dbo

      - name: Install SQLFluff and dbt deps
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt sqlfluff sqlfluff-templater-dbt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target dev

      - name: Lint SQL models
        env:
          DBT_ODBC_DRIVER: "ODBC Driver 18 for SQL Server"
          DBT_DEV_SERVER: localhost
          DBT_DEV_PORT: 1433
          DBT_DEV_USER: sa
          DBT_DEV_PASSWORD: Password123!
          DBT_DEV_DATABASE: AdventureWorks2014
          DBT_DEV_SCHEMA: dbo
        run: sqlfluff lint dbt/models

  dbt_compile:
    name: dbt compile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target dev

      - name: Compile models
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
        run: dbt compile --profiles-dir ../.github/dbt --target dev --warn-error --warn-error-options "{exclude: ['deprecation']}"

  dbt_tests:
    name: dbt tests on PRs
    runs-on: ubuntu-latest
    needs: dbt_compile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target dev

      - name: Run dbt tests
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
        run: dbt test --profiles-dir ../.github/dbt --target dev --store-failures --fail-fast

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-test-artifacts
          path: |
            dbt/target
            dbt/logs

  docs:
    name: Build dbt docs
    runs-on: ubuntu-latest
    needs: dbt_compile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ODBC dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dbt/requirements.txt

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps --profiles-dir ../.github/dbt --target dev

      - name: Generate docs
        working-directory: dbt
        env:
          DBT_DEV_SERVER: ${{ secrets.DBT_DEV_SERVER || 'localhost' }}
          DBT_DEV_USER: ${{ secrets.DBT_DEV_USER || 'sa' }}
          DBT_DEV_PASSWORD: ${{ secrets.DBT_DEV_PASSWORD || 'Password123!' }}
          DBT_DEV_DATABASE: ${{ secrets.DBT_DEV_DATABASE || 'AdventureWorks2014' }}
        run: dbt docs generate --profiles-dir ../.github/dbt --target dev

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: dbt/target
